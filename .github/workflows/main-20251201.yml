name: Build & Release

on:
  workflow_dispatch:

jobs:
  all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: wiiu
            ext: wuhb
          - platform: switch
            ext: nro
          - platform: wii
            ext: dol
    container: ghcr.io/fortheusers/sealeo:evo
    steps:
      - uses: actions/checkout@main
        with:
          submodules: recursive
          path: hb-appstore

      - name: Extract version and title from Makefile
        id: extract_meta
        run: |
          MAKEFILE="$GITHUB_WORKSPACE/hb-appstore/Makefile"
          
          if [ ! -f "$MAKEFILE" ]; then
            echo "ERROR: Makefile not found at $MAKEFILE"
            ls -la "$GITHUB_WORKSPACE/hb-appstore"
            exit 1
          fi
          
          APP_TITLE=$(awk -F ':=' '/^APP_TITLE/ {gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}' "$MAKEFILE")
          RAW_VERSION=$(awk -F ':=' '/^APP_VERSION/ {gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}' "$MAKEFILE")
          FULL_VERSION="v${RAW_VERSION}"
          
          echo "app_title=$APP_TITLE" >> $GITHUB_OUTPUT
          echo "app_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          
          if [ -z "$APP_TITLE" ] || [ -z "$RAW_VERSION" ] || [ "$FULL_VERSION" = "v" ]; then
            echo "ERROR: Failed to extract valid version/title from Makefile"
            echo "Extracted APP_TITLE: '$APP_TITLE'"
            echo "Extracted APP_VERSION: '$RAW_VERSION'"
            exit 1
          fi
        shell: bash

      - if: matrix.platform == 'wii'
        name: Setup SDL2 Widescreen
        run: |
          git clone https://github.com/Fancy2209/SDL -b Widescreen
          cd SDL
          apt-get install ninja-build
          cmake -D CMAKE_TOOLCHAIN_FILE=/opt/devkitpro/cmake/Wii.cmake -B build -G Ninja
          cmake --build build --parallel
          cmake --install build

      - name: Build ${{ matrix.platform }}
        run: |
          cd $GITHUB_WORKSPACE/hb-appstore
          make ${{ matrix.platform }}
          mkdir -p /github/workspace/build_output
          cp $GITHUB_WORKSPACE/hb-appstore/appstore.${{ matrix.ext }} /github/workspace/build_output/
          if [ "${{ matrix.platform }}" = "wiiu" ]; then
            cp $GITHUB_WORKSPACE/hb-appstore/appstore.rpx /github/workspace/build_output/
          fi
        shell: bash

      - name: Upload build artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: /github/workspace/build_output/
          if-no-files-found: error

  release:
    needs: all
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
        with:
          submodules: recursive
          path: hb-appstore

      - name: Extract version and title from Makefile
        id: extract_meta
        run: |
          MAKEFILE="$GITHUB_WORKSPACE/hb-appstore/Makefile"
          
          if [ ! -f "$MAKEFILE" ]; then
            echo "ERROR: Makefile not found at $MAKEFILE"
            ls -la "$GITHUB_WORKSPACE/hb-appstore"
            exit 1
          fi
          
          APP_TITLE=$(awk -F ':=' '/^APP_TITLE/ {gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}' "$MAKEFILE")
          RAW_VERSION=$(awk -F ':=' '/^APP_VERSION/ {gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}' "$MAKEFILE")
          FULL_VERSION="v${RAW_VERSION}"
          
          echo "app_title=$APP_TITLE" >> $GITHUB_OUTPUT
          echo "app_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          
          if [ -z "$APP_TITLE" ] || [ -z "$RAW_VERSION" ] || [ "$FULL_VERSION" = "v" ]; then
            echo "ERROR: Failed to extract valid version/title from Makefile"
            echo "Extracted APP_TITLE: '$APP_TITLE'"
            echo "Extracted APP_VERSION: '$RAW_VERSION'"
            exit 1
          fi
        shell: bash

      - name: Download all build outputs
        uses: actions/download-artifact@v4
        with:
          path: ./final_build
          merge-multiple: true

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_meta.outputs.app_version }}
          release_name: ${{ steps.extract_meta.outputs.app_title }} ${{ steps.extract_meta.outputs.app_version }}
          body: |
            ## Automated Build Release
            This release is automatically generated by GitHub Actions workflow.
            - Build version: ${{ steps.extract_meta.outputs.app_version }}
            - Build environment: ghcr.io/fortheusers/sealeo:evo (Ubuntu)
            - Build targets: WiiU, Switch, Wii
            - Build time: ${{ github.event.repository.updated_at }} (UTC)
          draft: false
          prerelease: false

      - name: Upload Switch (NRO) to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./final_build/appstore.nro
          asset_name: appstore-switch.nro
          asset_content_type: application/octet-stream

      - name: Upload WiiU (WUHB) to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./final_build/appstore.wuhb
          asset_name: appstore-wiiu.wuhb
          asset_content_type: application/octet-stream

      - name: Upload WiiU (RPX) to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./final_build/appstore.rpx
          asset_name: appstore-wiiu.rpx
          asset_content_type: application/octet-stream

      - name: Upload Wii (DOL) to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./final_build/appstore.dol
          asset_name: appstore-wii.dol
          asset_content_type: application/octet-stream
